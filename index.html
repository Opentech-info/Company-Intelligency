<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cap Table Simulator — Advanced</title>
  <style>
    /* ===== Advanced CSS Engine (variables, grid, container queries, clamp, calc) ===== */
    :root{
      --bg: linear-gradient(180deg,#0f172a 0%, #071024 100%);
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.06);
      --accent: #60a5fa;
      --accent-2: #7c3aed;
      --muted: #94a3b8;
      --glass-border: rgba(255,255,255,0.06);
      --success: #10b981;
      --danger: #ef4444;
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      --ease: cubic-bezier(.2,.9,.3,1);
      --maxw: 1100px;
    }

    /* Global reset */
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial;
      background: var(--bg);
      color: #e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:48px 20px;
      display:flex;align-items:flex-start;justify-content:center;
    }

    .wrap{width:100%;max-width:var(--maxw);}

    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;
    }

    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:58px;height:58px;border-radius:12px;background:conic-gradient(from 180deg at 50% 50%,var(--accent),var(--accent-2));display:grid;place-items:center;font-weight:700;color:#021124;font-size:18px;box-shadow:0 6px 30px rgba(2,8,23,0.6);
    }
    h1{font-size:20px;margin:0}
    h2{margin:0;font-size:13px;color:var(--muted)}

    /* Layout grid */
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}

    /* Card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border);padding:18px;border-radius:var(--radius);box-shadow:0 6px 30px rgba(2,8,23,0.6)}

    /* Controls */
    .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
    .field{display:flex;flex-direction:column}
    label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:inherit;font-size:14px}

    .btn{border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .18s var(--ease);}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021124}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn:active{transform:translateY(1px)}

    /* cap table */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:700;border-bottom:1px dashed rgba(255,255,255,0.03)}
    tbody tr{transition:transform .12s var(--ease)}
    tbody tr:hover{transform:translateY(-3px)}
    .pct{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}

    /* Notes panel */
    .notes{max-height:520px;overflow:auto;padding-right:6px}
    details{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));padding:10px;border-radius:10px;margin-bottom:8px}
    summary{cursor:pointer;font-weight:700}

    /* Chart */
    .chart-wrap{height:220px;display:grid;place-items:center}
    canvas{width:100%;max-width:100%;height:200px;border-radius:8px}

    /* Footer small */
    .muted{color:var(--muted);font-size:12px}

    /* Fancy responsive touch */
    @container (min-width:420px){
      .grid{grid-template-columns:1fr 460px}
    }

    /* tiny helpers */
    .row{display:flex;gap:12px;align-items:center}
    .space{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <h1>Cap Table Simulator</h1>
          <h2>Interactive dilution &amp; ownership calculator — founders, investors &amp; ESOP</h2>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="resetBtn">Reset</button>
        <button class="btn primary" id="exportBtn">Export CSV</button>
      </div>
    </header>

    <main class="grid">
      <!-- Left: simulation area -->
      <section class="card">
        <h3 style="margin-top:0">Setup participants</h3>
        <div class="controls" id="participants">
          <div class="field">
            <label>Founders (count)</label>
            <input type="number" id="founderCount" min="1" value="4" />
          </div>
          <div class="field">
            <label>Total founder shares (initial %)</label>
            <input type="number" id="founderTotalPct" min="1" max="100" value="100" />
          </div>
          <div class="field">
            <label>ESOP reserve (%)</label>
            <input type="number" id="esopPct" min="0" max="50" value="10" />
          </div>
          <div class="field">
            <label>Pre-money valuation (in USD)</label>
            <input type="number" id="preMoney" min="0" value="2000000" />
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0" />

        <h3 style="margin:0 0 8px 0">Funding rounds</h3>
        <div id="rounds"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn ghost" id="addRoundBtn">+ Add round</button>
          <button class="btn primary" id="runSimBtn">Run simulation</button>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0" />

        <div class="row" style="align-items:flex-end">
          <div>
            <div class="muted">Post-money valuation (computed)</div>
            <div id="postMoneyDisplay" style="font-weight:800;font-size:16px">—</div>
          </div>
          <div class="space"></div>
          <div class="muted">Total Dilution</div>
          <div id="totalDilution" style="font-weight:800">—</div>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0" />

        <h3 style="margin:0 0 8px 0">Cap Table</h3>
        <div style="overflow:auto">
          <table id="capTable">
            <thead>
              <tr><th>Stakeholder</th><th>Shares</th><th>% Ownership</th><th>Notes</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </section>

      <!-- Right: notes & visualization -->
      <aside class="card">
        <h3 style="margin-top:0">Notes & Concepts</h3>
        <div class="notes">
          <details open>
            <summary>Key concepts (founders, dilution, ESOP, pre/post-money)</summary>
            <p class="sub">Founders: the original owners of the company. Dilution: reduction in percentage ownership when new shares are issued. ESOP: reserve of shares for employees. Pre-money: company valuation before investment. Post-money: valuation after receiving funds.</p>
          </details>

          <details>
            <summary>Recommended ownership strategy</summary>
            <ol>
              <li>Keep founders' combined ownership >50% for early control.</li>
              <li>Reserve 5–15% for ESOP before investors unless negotiated otherwise.</li>
              <li>First investor rounds commonly give 10–30% to investors.</li>
              <li>Use clear shareholders' and founders' agreements to avoid disputes.</li>
            </ol>
          </details>

          <details>
            <summary>Model notes (how the simulator works)</summary>
            <p class="sub">This simulator assumes simple % ownership issuance per round: i.e., Investor is granted X% of the company post-money. ESOP is applied as a pool created at the chosen stage, causing pro-rata dilution across existing stakeholders. The math keeps the total at 100% after each update.</p>
          </details>

          <details>
            <summary>Advanced tips</summary>
            <ul>
              <li>Negotiate option pool expansion to be created <em>pre-money</em> or <em>post-money</em> — this affects founders' dilution.</li>
              <li>Prefer anti-dilution clauses with caution — they can complicate future rounds.</li>
              <li>Track a cap table in Excel and update after each transaction; keep legal counsel for share issuance.</li>
            </ul>
          </details>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0" />

        <h3 style="margin:0 0 8px 0">Visualization</h3>
        <div class="chart-wrap card" style="padding:12px">
          <canvas id="pieChart" width="400" height="200"></canvas>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <div class="muted">Dark UI</div>
          <div class="space"></div>
          <button class="btn ghost" id="notesAdvice">Quick advice</button>
        </div>

      </aside>
    </main>
  </div>

  <script>
    /* ===== Helper utilities ===== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // state
    let state = {
      founderCount: 4,
      founderTotalPct: 100,
      esopPct: 10,
      preMoney: 2000000,
      rounds: [ {name:'Seed', pct:20, preMoney:false} ]
    };

    // DOM references
    const founderCountEl = $('#founderCount');
    const founderTotalPctEl = $('#founderTotalPct');
    const esopPctEl = $('#esopPct');
    const preMoneyEl = $('#preMoney');
    const roundsEl = $('#rounds');
    const runSimBtn = $('#runSimBtn');
    const addRoundBtn = $('#addRoundBtn');
    const capTableBody = $('#capTable tbody');
    const postMoneyDisplay = $('#postMoneyDisplay');
    const totalDilutionEl = $('#totalDilution');
    const exportBtn = $('#exportBtn');
    const resetBtn = $('#resetBtn');
    const pieCanvas = document.getElementById('pieChart');
    const notesAdvice = $('#notesAdvice');

    function renderRounds(){
      roundsEl.innerHTML = '';
      state.rounds.forEach((r,idx)=>{
        const div = document.createElement('div');
        div.className='row';
        div.style.marginBottom='8px';
        div.innerHTML = `
          <div style="flex:1">
            <label style="font-size:12px;color:var(--muted)">Round name</label>
            <input data-i="${idx}" class="round-name" value="${r.name}" />
          </div>
          <div style="width:140px">
            <label style="font-size:12px;color:var(--muted)">Investor % (post-money)</label>
            <input data-i="${idx}" type="number" min="0" max="80" class="round-pct" value="${r.pct}" />
          </div>
          <div style="width:120px">
            <label style="font-size:12px;color:var(--muted)">Pre-money?</label>
            <select data-i="${idx}" class="round-pre">
              <option ${r.preMoney? 'selected' : ''} value="1">Yes (pre-money)</option>
              <option ${r.preMoney? '' : 'selected'} value="0">No (post-money)</option>
            </select>
          </div>
          <div>
            <button data-i="${idx}" class="btn ghost del">Del</button>
          </div>
        `;
        roundsEl.appendChild(div);
      });

      // attach listeners
      $$('.round-name').forEach(el=>el.addEventListener('input', e=> state.rounds[+e.target.dataset.i].name = e.target.value));
      $$('.round-pct').forEach(el=>el.addEventListener('input', e=> state.rounds[+e.target.dataset.i].pct = +e.target.value));
      $$('.round-pre').forEach(el=>el.addEventListener('change', e=> state.rounds[+e.target.dataset.i].preMoney = !!+e.target.value));
      $$('.del').forEach(el=>el.addEventListener('click', e=>{ state.rounds.splice(+e.target.dataset.i,1); renderRounds(); }));
    }

    function buildInitialCap(){
      // initialize base cap
      const founders = state.founderCount;
      const founderTotalPct = state.founderTotalPct/100;
      // we model shares as units; start with 10000 base
      const base = 1000000;
      const cap = [];
      const founderSharesEach = Math.round(base * founderTotalPct / founders);
      for(let i=0;i<founders;i++) cap.push({name:`Founder ${i+1}`, shares:founderSharesEach, kind:'founder'});
      return cap;
    }

    function simulate(){
      // This simulation simplifies: it starts with founders owning 100% of shares (or specified), then for each round, issues new shares such that investor gets the specified *post-money* % of outstanding.
      let cap = buildInitialCap();
      let totalShares = cap.reduce((s,p)=>s+p.shares,0);

      // optionally create ESOP before rounds? We'll create ESOP as a pool applied after all rounds (common approach) - but we allow pattern by toggling later. For clarity we apply ESOP at the end as a % of post-money.

      let investorList = [];
      let cumulativeNewShares = 0;
      let postMoneyVal = state.preMoney;

      state.rounds.forEach((r,idx)=>{
        // calculate new shares to give investor so that investorShare / (existing + new) = r.pct/100
        const investorFraction = r.pct/100;
        // newShares = existingShares * investorFraction / (1 - investorFraction)
        const existingShares = totalShares;
        const newShares = Math.round(existingShares * investorFraction / (1 - investorFraction));
        totalShares += newShares;
        cumulativeNewShares += newShares;
        investorList.push({name:r.name, shares:newShares, pct:r.pct});
      });

      // Apply ESOP as % of total post-money
      const esopShares = Math.round(totalShares * (state.esopPct/100));
      totalShares += esopShares;

      // recompute owners' percentages
      // founders shares remain same absolute, investors have newShares, esop pool allocated
      const rows = [];
      cap.forEach(p => rows.push({name:p.name, shares:p.shares, role:p.kind}));
      investorList.forEach(inv => rows.push({name:inv.name, shares:inv.shares, role:'investor'}));
      rows.push({name:'ESOP Pool', shares:esopShares, role:'esop'});

      // compute percentages
      rows.forEach(r => { r.pct = +(100 * r.shares / totalShares).toFixed(4); });

      // compute post-money value simple: assume last round price implied by pre-money & new cash
      // We don't have cash amounts; approximate: postMoney = preMoney / (1 - sumInvestorPct)
      const totalInvestorPct = state.rounds.reduce((s,r)=>s + (r.pct/100),0);
      const postMoney = totalInvestorPct >= 1 ? state.preMoney : Math.round(state.preMoney / (1 - totalInvestorPct));

      // total dilution experienced by founders: initial pct - final pct
      const founderRows = rows.filter(r=>r.role==='founder');
      const foundersFinalPct = founderRows.reduce((s,r)=>s + r.pct,0);

      return {rows,totalShares,postMoney,foundersFinalPct,totalInvestorPct};
    }

    function renderCapTable(sim){
      capTableBody.innerHTML='';
      sim.rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div style="font-weight:700">${r.name}</div><div class="sub">${r.role}</div></td>
          <td>${r.shares.toLocaleString()}</td>
          <td><span class="pct">${r.pct.toFixed(2)}%</span></td>
          <td class="sub">—</td>
        `;
        capTableBody.appendChild(tr);
      });

      postMoneyDisplay.textContent = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(sim.postMoney);
      totalDilutionEl.textContent = (100 - sim.foundersFinalPct).toFixed(2) + "% total (founders combined)";

      renderPie(sim.rows);
    }

    function renderPie(rows){
      const ctx = pieCanvas.getContext('2d');
      const w = pieCanvas.width; const h = pieCanvas.height; ctx.clearRect(0,0,w,h);
      const total = rows.reduce((s,r)=>s+r.shares,0);
      let start = -Math.PI/2;
      rows.forEach((r,i)=>{
        const frac = r.shares/total;
        const end = start + frac * Math.PI * 2;
        // color by role
        let color = ['#60a5fa','#7c3aed','#10b981','#f97316','#ef4444'][i%5];
        ctx.beginPath();
        ctx.moveTo(w/2,h/2);
        ctx.arc(w/2,h/2,80,start,end);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
        start = end;
      });

      // legend
      ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
      let lx = 10; let ly = 12;
      rows.forEach((r,i)=>{
        const color = ['#60a5fa','#7c3aed','#10b981','#f97316','#ef4444'][i%5];
        ctx.fillStyle = color;
        ctx.fillRect(lx, ly, 10, 10);
        ctx.fillStyle = '#e6eef8';
        ctx.fillText(`${r.name} — ${r.pct.toFixed(2)}%`, lx+16, ly+10);
        ly += 18;
      });
    }

    // exports
    function exportCSV(sim){
      const rows = sim.rows;
      let csv = 'Stakeholder,Shares,Percent\n';
      rows.forEach(r=> csv += `${r.name},${r.shares},${r.pct.toFixed(4)}\n`);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'cap_table.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // attach controls
    founderCountEl.addEventListener('input', e => { state.founderCount = Math.max(1, +e.target.value); });
    founderTotalPctEl.addEventListener('input', e => { state.founderTotalPct = Math.max(1, Math.min(100, +e.target.value)); });
    esopPctEl.addEventListener('input', e => { state.esopPct = Math.max(0, Math.min(50, +e.target.value)); });
    preMoneyEl.addEventListener('input', e => { state.preMoney = Math.max(0, +e.target.value); });

    addRoundBtn.addEventListener('click', ()=>{ state.rounds.push({name:'NewRound', pct:10, preMoney:false}); renderRounds(); });
    runSimBtn.addEventListener('click', ()=>{ const sim = simulate(); renderCapTable(sim); });
    exportBtn.addEventListener('click', ()=>{ const sim = simulate(); exportCSV(sim); });
    resetBtn.addEventListener('click', ()=>{ state = { founderCount:4, founderTotalPct:100, esopPct:10, preMoney:2000000, rounds:[ {name:'Seed', pct:20, preMoney:false} ] }; founderCountEl.value=4; founderTotalPctEl.value=100; esopPctEl.value=10; preMoneyEl.value=2000000; renderRounds(); runSimBtn.click(); });
    notesAdvice.addEventListener('click', ()=> alert('Tip: Keep founders combined >50% early. Negotiate option pool creation pre- or post-money carefully — pre-money pool expansion dilutes founders more.'));

    // initial render
    renderRounds(); runSimBtn.click();

  </script>
</body>
</html>
